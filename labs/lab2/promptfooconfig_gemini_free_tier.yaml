$schema: https://promptfoo.dev/config-schema.json
description: 'Lab 2 eval: Ultra-conservative config for Google AI Studio FREE TIER (15 RPM limit)'

providers:
  - id: google:gemini-2.5-flash
    label: gemini-batch-free
    config:
      apiKey: "{{ env.GEMINI_API_KEY }}"
      temperature: 0
      showThinking: false
      response_format:
        type: json_object

prompts:
  # ONLY use JSON prompt - baseline_prompt.txt conflicts with response_format: json_object
  - file://prompts/secure_review_chat.json

defaultTest:
  assert:
    - type: is-json
    - type: javascript
      metric: accuracy
      value: |
        const expected = '{{ label }}';
        const obj = typeof output === 'string' ? JSON.parse(output) : output;
        let actual = obj.is_vuln;
        
        if (actual === undefined && typeof obj.is_vulnerable === 'boolean') {
          actual = obj.is_vulnerable ? 'yes' : 'no';
        } else if (actual === undefined && typeof obj.is_vulnerable === 'string') {
          const v = obj.is_vulnerable.toLowerCase();
          if (v.includes('yes') || v.includes('true')) actual = 'yes';
          if (v.includes('no')  || v.includes('false')) actual = 'no';
        }
        
        // Enhanced feedback with detailed error message
        if (actual === expected) {
          return {
            pass: true,
            score: 1,
            reason: `‚úÖ Correct classification: ${actual} (CWE: ${obj.cwe || 'N/A'})`
          };
        } else {
          return {
            pass: false,
            score: 0,
            reason: `‚ùå WRONG: Expected "${expected}" but got "${actual}"\n` +
                    `   Model said: ${obj.title || 'N/A'}\n` +
                    `   Rationale: ${obj.rationale?.substring(0, 150) || 'N/A'}...\n` +
                    `   CWE: ${obj.cwe || 'none detected'}\n` +
                    `   üí° FIX: Review prompt or provide better examples for this vulnerability type`
          };
        }

tests: file://_generated/tests_flat.yaml

evaluateOptions:
  # CRITICAL for Google AI Studio free tier (15 requests per minute)
  maxConcurrency: 1        # ONE request at a time - NEVER change this
  delay: 5000              # 5 seconds = 12 RPM (safely under 15 RPM limit)
  timeoutSeconds: 180      # 3 minutes timeout per request
  
  # With these settings (1 prompt only):
  # - 2 tests per batch √ó 1 prompt = 2 API calls
  # - 2 calls √ó 5 seconds = 10 seconds per batch minimum
  # - Plus actual API response time ~5-10s
  # - Total: ~15-20 seconds per batch of 2 tests
  # - Use --delay 180 between batches for 3-minute cooling
